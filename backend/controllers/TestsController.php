<?php
namespace backend\controllers;

use Yii;
use yii\web\Controller;

Class TestsController extends Controller {

    public $enableCsrfValidation = false;
    protected $server;
    const  HOST = "0.0.0.0";
    const  PORT = "9501";

//    public function init()
//    {
//        \Yii::$app->user->enableSession = false;
//        parent::init(); // TODO: Change the autogenerated stub
//    }
//
    public function __construct()
    {
        $this->server = new \swoole_websocket_server(self::HOST, self::PORT);

        $this->server->on('Start', [$this, 'onStart']);

    }


    public function behaviors()
    {
        $behaviors = parent::behaviors();
//        $behaviors['authenticator'] =[
//            'class'=>QueryParamAuth::className(),
//        ];
        return $behaviors;
    }


    /**
     * Displays homepage.
     *
     * @return string
     */
    public function actionOpen($server, $request)
    {
        echo "发送的客户端标示:".$request->fd;

        $server->push($request->fd, "hello world");


    }
    //监听websocket消息事件
    public function actionMessage($server, $frame)
    {
        echo "客户端:".$frame->fd."发送了数据,".$frame->data;
        $server->push($frame->fd, "Server:{$frame->data}");
    }

    public function actionClose($server, $fd)
    {
        return "Close:{$fd}-close";
        /** @var Application */

    }
}